# Software Bill of Materials (SBOM) Generation
# See: https://cyclonedx.org/

name: SBOM Generation

on:
  push:
    branches: [main]
  release:
    types: [published]
  workflow_dispatch:

# Least-privilege permissions - artifacts only, no repository writes
permissions:
  contents: read  # Read-only access for checkout
  actions: write  # To upload artifacts
  
jobs:
  generate-sbom:
    name: Generate SBOM
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install CycloneDX
        run: |
          pip install cyclonedx-bom
          
      - name: Generate Python SBOM
        run: |
          # Generate SBOM from requirements.txt
          cyclonedx-py requirements \
            -r requirements.txt \
            -o sbom-python.json \
            --format json
            
          # Also generate XML format
          cyclonedx-py requirements \
            -r requirements.txt \
            -o sbom-python.xml \
            --format xml
            
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        
      - name: Install cargo-cyclonedx
        run: |
          cargo install cargo-cyclonedx
          
      - name: Generate Rust SBOM (attestation-engine)
        working-directory: crates/attestation-engine
        run: |
          cargo cyclonedx --format json --output-cdx
          mv *.cdx.json ../../sbom-rust-attestation.json || true
          
      - name: Upload SBOM Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: |
            sbom-*.json
            sbom-*.xml
          retention-days: 90
          
      # Note: Auto-commit disabled for security best practices
      # SBOM files are available as workflow artifacts and can be downloaded
      # If auto-commit is needed, enable 'contents: write' permission and ensure:
      # 1. Workflow cannot be triggered from forks
      # 2. Branch protection rules are in place
      # 3. Commits are signed and verified
          
      - name: SBOM Summary
        run: |
          echo "### ðŸ“¦ SBOM Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Software Bill of Materials generated for:" >> $GITHUB_STEP_SUMMARY
          echo "- Python dependencies (requirements.txt)" >> $GITHUB_STEP_SUMMARY
          echo "- Rust crates (attestation-engine)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Format: CycloneDX (JSON + XML)" >> $GITHUB_STEP_SUMMARY
