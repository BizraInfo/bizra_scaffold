# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# BIZRA AEON OMEGA - Metrics Verification Merge Gate
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 
# This workflow implements fail-closed verification:
#   - VERIFIED â†’ merge allowed
#   - PENDING â†’ merge blocked, evidence collection triggered
#   - FAIL_CLOSED â†’ merge blocked, alert triggered
#
# Aligned with IhsÄn principles: ØµØ¯Ù‚ (Truthfulness) + Ø£Ù…Ø§Ù†Ø© (Trustworthiness)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "ğŸ”¬ Metrics Verification Gate"

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      mode:
        description: 'Verification mode'
        required: true
        default: 'metrics'
        type: choice
        options:
          - metrics
          - full
          - perf
          - determinism
      profile:
        description: 'Execution profile'
        required: true
        default: 'ci'
        type: choice
        options:
          - ci
          - dev
          - prod
          - benchmark

# Prevent concurrent verification runs
concurrency:
  group: verify-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.11"
  RUST_VERSION: "1.75"
  EVIDENCE_DIR: "evidence/metrics"
  RECEIPT_PATH: "evidence/metrics/latest.json"
  MIN_COVERAGE: "55"

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 1: Environment Fingerprinting
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  environment:
    name: "ğŸ“‹ Environment Fingerprint"
    runs-on: ubuntu-latest
    outputs:
      commit_sha: ${{ steps.env.outputs.commit_sha }}
      branch: ${{ steps.env.outputs.branch }}
      repo_clean: ${{ steps.env.outputs.repo_clean }}
      python_version: ${{ steps.env.outputs.python_version }}
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Collect Environment
        id: env
        run: |
          echo "commit_sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "branch=$(git branch --show-current || echo 'detached')" >> $GITHUB_OUTPUT
          echo "repo_clean=$(git status --porcelain | wc -l | xargs test 0 -eq && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "python_version=${{ env.PYTHON_VERSION }}" >> $GITHUB_OUTPUT
          
      - name: Display Fingerprint
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  Environment Fingerprint                                      â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  Commit: ${{ steps.env.outputs.commit_sha }}   â•‘"
          echo "â•‘  Branch: ${{ steps.env.outputs.branch }}                      â•‘"
          echo "â•‘  Clean:  ${{ steps.env.outputs.repo_clean }}                  â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 2: Codebase Metrics (LOC, Structure)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  loc-metrics:
    name: "ğŸ“Š Lines of Code"
    runs-on: ubuntu-latest
    needs: environment
    outputs:
      loc_total: ${{ steps.loc.outputs.total }}
      loc_python: ${{ steps.loc.outputs.python }}
      loc_rust: ${{ steps.loc.outputs.rust }}
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Install tokei
        run: |
          curl -sSL https://github.com/XAMPPRocky/tokei/releases/download/v12.1.2/tokei-x86_64-unknown-linux-gnu.tar.gz | tar xz
          chmod +x tokei
          
      - name: Count Lines of Code
        id: loc
        run: |
          ./tokei . --output json > loc-report.json
          
          # Extract counts
          TOTAL=$(jq '.Total.code' loc-report.json)
          PYTHON=$(jq '.Python.code // 0' loc-report.json)
          RUST=$(jq '.Rust.code // 0' loc-report.json)
          
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "python=$PYTHON" >> $GITHUB_OUTPUT
          echo "rust=$RUST" >> $GITHUB_OUTPUT
          
          echo "ğŸ“Š LOC Report:"
          echo "   Total:  $TOTAL"
          echo "   Python: $PYTHON"
          echo "   Rust:   $RUST"
          
      - name: Upload LOC Report
        uses: actions/upload-artifact@v4
        with:
          name: loc-report
          path: loc-report.json
          retention-days: 30

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 3: Test Execution
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  test-suite:
    name: "ğŸ§ª Test Suite"
    runs-on: ubuntu-latest
    needs: environment
    outputs:
      total: ${{ steps.tests.outputs.total }}
      passed: ${{ steps.tests.outputs.passed }}
      failed: ${{ steps.tests.outputs.failed }}
      skipped: ${{ steps.tests.outputs.skipped }}
      pass_rate: ${{ steps.tests.outputs.pass_rate }}
      exit_code: ${{ steps.tests.outputs.exit_code }}
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          
      - name: Install Dependencies
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          pip install pytest pytest-cov pytest-asyncio
          
      - name: Run Tests
        id: tests
        run: |
          # Run pytest with JUnit XML output (capture exit code for fail-closed)
          set +e  # Don't exit on error - we need to capture the exit code
          python -m pytest tests/ \
            -v \
            --tb=short \
            --junitxml=test-results.xml \
            --cov=core \
            --cov-report=xml:coverage.xml \
            --cov-report=term-missing
          PYTEST_EXIT=$?
          
          # CRITICAL: Write exit code FIRST before any parsing that might fail
          echo "exit_code=$PYTEST_EXIT" >> $GITHUB_OUTPUT
          
          set -e
          
          # Parse results
          if [ -f test-results.xml ]; then
            TOTAL=$(grep -oP 'tests="\K\d+' test-results.xml | head -1)
            FAILURES=$(grep -oP 'failures="\K\d+' test-results.xml | head -1)
            SKIPPED=$(grep -oP 'skipped="\K\d+' test-results.xml | head -1)
            ERRORS=$(grep -oP 'errors="\K\d+' test-results.xml | head -1)
            
            PASSED=$((TOTAL - FAILURES - SKIPPED - ERRORS))
            
            # FAIL-CLOSED: Count errors as failures
            FAILED=$((FAILURES + ERRORS))
            
            if [ "$TOTAL" -gt 0 ]; then
              PASS_RATE=$(echo "scale=2; $PASSED * 100 / $TOTAL" | bc)
            else
              PASS_RATE=0
            fi
            
            echo "total=$TOTAL" >> $GITHUB_OUTPUT
            echo "passed=$PASSED" >> $GITHUB_OUTPUT
            echo "failed=$FAILED" >> $GITHUB_OUTPUT
            echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
            echo "errors=$ERRORS" >> $GITHUB_OUTPUT
            echo "pass_rate=$PASS_RATE" >> $GITHUB_OUTPUT
          else
            # FAIL-CLOSED: Missing JUnit file is a failure
            echo "total=0" >> $GITHUB_OUTPUT
            echo "passed=0" >> $GITHUB_OUTPUT
            echo "failed=1" >> $GITHUB_OUTPUT
            echo "skipped=0" >> $GITHUB_OUTPUT
            echo "errors=1" >> $GITHUB_OUTPUT
            echo "pass_rate=0" >> $GITHUB_OUTPUT
          fi
          
      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            test-results.xml
            coverage.xml
          retention-days: 30
          
      - name: Test Summary
        run: |
          echo "### ğŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total | ${{ steps.tests.outputs.total }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Passed | ${{ steps.tests.outputs.passed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Failed | ${{ steps.tests.outputs.failed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Skipped | ${{ steps.tests.outputs.skipped }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Pass Rate | ${{ steps.tests.outputs.pass_rate }}% |" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 4: Coverage Analysis
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  coverage:
    name: "ğŸ“ˆ Coverage Analysis"
    runs-on: ubuntu-latest
    needs: test-suite
    outputs:
      line_coverage: ${{ steps.coverage.outputs.line_coverage }}
      status: ${{ steps.coverage.outputs.status }}
      
    steps:
      - name: Download Coverage
        uses: actions/download-artifact@v4
        with:
          name: test-results
          
      - name: Parse Coverage
        id: coverage
        run: |
          if [ -f coverage.xml ]; then
            LINE_RATE=$(grep -oP 'line-rate="\K[\d.]+' coverage.xml | head -1)
            COVERAGE=$(echo "scale=1; $LINE_RATE * 100" | bc)
            
            # Determine status
            TARGET=95
            if (( $(echo "$COVERAGE >= $TARGET" | bc -l) )); then
              STATUS="Green"
            elif (( $(echo "$COVERAGE >= $TARGET * 0.9" | bc -l) )); then
              STATUS="Yellow"
            else
              STATUS="Red"
            fi
            
            echo "line_coverage=$COVERAGE" >> $GITHUB_OUTPUT
            echo "status=$STATUS" >> $GITHUB_OUTPUT
          else
            echo "line_coverage=0" >> $GITHUB_OUTPUT
            echo "status=Red" >> $GITHUB_OUTPUT
          fi
          
      - name: Coverage Badge
        run: |
          COVERAGE=${{ steps.coverage.outputs.line_coverage }}
          STATUS=${{ steps.coverage.outputs.status }}
          
          echo "### ğŸ“ˆ Coverage: ${COVERAGE}% (${STATUS})" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 5: Security Scan
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  security-scan:
    name: "ğŸ”’ Security Scan"
    runs-on: ubuntu-latest
    needs: environment
    outputs:
      secrets_found: ${{ steps.scan.outputs.secrets_found }}
      vulnerabilities: ${{ steps.scan.outputs.vulnerabilities }}
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Run Gitleaks
        id: gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        # FAIL-CLOSED: Use continue-on-error to capture result, then check outcome in Aggregate
        continue-on-error: true
        
      - name: Check keys/ directory
        id: keys
        run: |
          SECRETS_FOUND="false"
          if [ -d "keys" ]; then
            # Flag obvious secret/private filenames (exclude README/example/public)
            NAME_MATCHES=$(find keys -type f \( -name "*private*" -o -name "*secret*" \) ! -name "*.example" ! -name "README*" ! -name "*public*" -print)
            # Detect PEM private keys by content (public keys won't match)
            PEM_PRIVATE=$(grep -RIl --exclude="*.example" --exclude="README*" -e "BEGIN .*PRIVATE KEY" -e "BEGIN OPENSSH PRIVATE KEY" keys || true)
            if [ -n "$NAME_MATCHES" ] || [ -n "$PEM_PRIVATE" ]; then
              echo "âŒ FAIL_CLOSED: Private key material found in keys/ directory"
              if [ -n "$NAME_MATCHES" ]; then
                echo "Name matches:"
                echo "$NAME_MATCHES"
              fi
              if [ -n "$PEM_PRIVATE" ]; then
                echo "PEM private key matches:"
                echo "$PEM_PRIVATE"
              fi
              SECRETS_FOUND="true"
            fi
          fi
          echo "secrets_found=$SECRETS_FOUND" >> $GITHUB_OUTPUT
          
      - name: Aggregate Results
        id: scan
        run: |
          # FAIL-CLOSED: Include gitleaks exit code in secrets detection
          GITLEAKS_EXIT=${{ steps.gitleaks.outcome == 'failure' && 'true' || 'false' }}
          KEYS_SECRETS=${{ steps.keys.outputs.secrets_found || 'false' }}
          
          if [ "$GITLEAKS_EXIT" = "true" ] || [ "$KEYS_SECRETS" = "true" ]; then
            echo "secrets_found=true" >> $GITHUB_OUTPUT
          else
            echo "secrets_found=false" >> $GITHUB_OUTPUT
          fi
          
          # Count vulnerabilities from gitleaks (if report exists)
          VULN_COUNT=0
          if [ -f "gitleaks-report.json" ]; then
            VULN_COUNT=$(jq 'length' gitleaks-report.json 2>/dev/null || echo "0")
          fi
          echo "vulnerabilities=$VULN_COUNT" >> $GITHUB_OUTPUT

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 6: Generate Receipt
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  generate-receipt:
    name: "ğŸ“œ Generate Receipt"
    runs-on: ubuntu-latest
    needs: [environment, loc-metrics, test-suite, coverage, security-scan]
    outputs:
      state: ${{ steps.receipt.outputs.state }}
      receipt_hash: ${{ steps.receipt.outputs.receipt_hash }}
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          
      - name: Generate Receipt JSON
        id: receipt
        run: |
          mkdir -p ${{ env.EVIDENCE_DIR }}
          
          # Compute verification state with safe defaults and validation
          FAILED="${{ needs.test-suite.outputs.failed }}"
          FAILED=${FAILED:-0}
          FAILED=$((FAILED + 0))  # Coerce to integer
          
          # FAIL-CLOSED: Check pytest exit code directly
          EXIT_CODE="${{ needs.test-suite.outputs.exit_code }}"
          EXIT_CODE=${EXIT_CODE:-1}  # Default to failure if missing
          EXIT_CODE=$((EXIT_CODE + 0))  # Coerce to integer
          
          SECRETS="${{ needs.security-scan.outputs.secrets_found }}"
          SECRETS=${SECRETS:-false}
          # Normalize to true/false
          if [ "$SECRETS" != "true" ]; then
            SECRETS="false"
          fi
          
          COVERAGE="${{ needs.coverage.outputs.line_coverage }}"
          COVERAGE=${COVERAGE:-0}
          COVERAGE=$((${COVERAGE%.*} + 0))  # Coerce to integer, strip decimals

          MIN_COVERAGE="${{ env.MIN_COVERAGE }}"
          MIN_COVERAGE=${MIN_COVERAGE:-70}
          MIN_COVERAGE=$((MIN_COVERAGE + 0))
          
          # FAIL-CLOSED: Exit code trumps everything - catches crashes, errors, missing tests
          if [ "$EXIT_CODE" -ne 0 ]; then
            STATE="FAIL_CLOSED"
          elif [ "$FAILED" -gt 0 ] || [ "$SECRETS" = "true" ]; then
            STATE="FAIL_CLOSED"
          elif [ "$COVERAGE" -lt "$MIN_COVERAGE" ]; then
            STATE="PENDING"
          else
            STATE="VERIFIED"
          fi
          
          # Generate receipt
          cat > ${{ env.RECEIPT_PATH }} << EOF
          {
            "meta": {
              "receipt_id": "$(uuidgen 2>/dev/null || python3 -c 'import uuid; print(uuid.uuid4())' 2>/dev/null || cat /proc/sys/kernel/random/uuid 2>/dev/null || echo "00000000-0000-4000-8000-$(date +%s%N | sha256sum | head -c 12)")",
              "generated_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
              "generator_version": "1.0.0",
              "mode": "metrics",
              "profile": "ci"
            },
            "environment": {
              "commit_sha": "${{ needs.environment.outputs.commit_sha }}",
              "branch": "${{ needs.environment.outputs.branch }}",
              "repo_clean": ${{ needs.environment.outputs.repo_clean }},
              "python_version": "${{ needs.environment.outputs.python_version }}",
              "os": "ubuntu-latest",
              "cpu_count": $(nproc)
            },
            "metrics": {
              "loc": {
                "total": ${{ needs.loc-metrics.outputs.loc_total }},
                "python": ${{ needs.loc-metrics.outputs.loc_python }},
                "rust": ${{ needs.loc-metrics.outputs.loc_rust }}
              },
              "tests": {
                "total": ${{ needs.test-suite.outputs.total }},
                "passed": ${{ needs.test-suite.outputs.passed }},
                "failed": ${{ needs.test-suite.outputs.failed }},
                "skipped": ${{ needs.test-suite.outputs.skipped }},
                "pass_rate": ${{ needs.test-suite.outputs.pass_rate }}
              },
              "coverage": {
                "line_coverage_percent": ${{ needs.coverage.outputs.line_coverage }},
                "status": "${{ needs.coverage.outputs.status }}",
                "target_percent": ${{ env.MIN_COVERAGE }}
              },
              "security": {
                "secrets_found": ${{ needs.security-scan.outputs.secrets_found }},
                "vulnerabilities": ${{ needs.security-scan.outputs.vulnerabilities }}
              }
            },
            "state": "$STATE",
            "integrity": {
              "hash_algorithm": "SHA-256"
            }
          }
          EOF
          
          # Compute content hash
          HASH=$(sha256sum ${{ env.RECEIPT_PATH }} | cut -d' ' -f1)
          
          # Update receipt with hash
          jq ".integrity.content_hash = \"$HASH\"" ${{ env.RECEIPT_PATH }} > tmp.json
          mv tmp.json ${{ env.RECEIPT_PATH }}
          
          echo "state=$STATE" >> $GITHUB_OUTPUT
          echo "receipt_hash=$HASH" >> $GITHUB_OUTPUT
          
      - name: Upload Receipt
        uses: actions/upload-artifact@v4
        with:
          name: metrics-receipt
          path: ${{ env.RECEIPT_PATH }}
          retention-days: 90
          
      - name: Receipt Summary
        run: |
          STATE=${{ steps.receipt.outputs.state }}
          HASH=${{ steps.receipt.outputs.receipt_hash }}
          
          echo "### ğŸ“œ Metrics Receipt" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| State | **$STATE** |" >> $GITHUB_STEP_SUMMARY
          echo "| Hash | \`${HASH:0:16}...\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ needs.environment.outputs.commit_sha }} |" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 7: Verification Gate (Merge Blocking)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  verification-gate:
    name: "ğŸš¦ Verification Gate"
    runs-on: ubuntu-latest
    needs: [generate-receipt]
    if: always()
    
    steps:
      - name: Check Verification State
        run: |
          STATE="${{ needs.generate-receipt.outputs.state }}"
          
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  BIZRA Verification Gate                                      â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          
          case "$STATE" in
            "VERIFIED")
              echo "â•‘  âœ… VERIFIED - Merge Allowed                                 â•‘"
              echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              exit 0
              ;;
            "PENDING")
              echo "â•‘  â³ PENDING - Evidence Collection Required                   â•‘"
              echo "â•‘  Merge blocked until all metrics meet thresholds            â•‘"
              echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              exit 1
              ;;
            "FAIL_CLOSED")
              echo "â•‘  âŒ FAIL_CLOSED - Merge Blocked                              â•‘"
              echo "â•‘  Evidence contradicts claims - investigation required       â•‘"
              echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              exit 1
              ;;
            *)
              echo "â•‘  â“ UNKNOWN - Defaulting to FAIL_CLOSED                      â•‘"
              echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              exit 1
              ;;
          esac
          
      - name: Gate Summary
        if: always()
        run: |
          STATE="${{ needs.generate-receipt.outputs.state }}"
          
          if [ "$STATE" == "VERIFIED" ]; then
            echo "### âœ… Verification Gate: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Verification Gate: BLOCKED ($STATE)" >> $GITHUB_STEP_SUMMARY
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 8: Commit Receipt (on success)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  commit-receipt:
    name: "ğŸ’¾ Commit Receipt"
    runs-on: ubuntu-latest
    needs: [generate-receipt, verification-gate]
    if: needs.generate-receipt.outputs.state == 'VERIFIED' && github.event_name == 'push'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Download Receipt
        uses: actions/download-artifact@v4
        with:
          name: metrics-receipt
          path: ${{ env.EVIDENCE_DIR }}
          
      - name: Commit Receipt
        run: |
          git config user.name "BIZRA Verification Bot"
          git config user.email "verify@bizra.io"
          
          git add ${{ env.EVIDENCE_DIR }}/
          
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ğŸ“œ [verify-metrics] Receipt for ${{ needs.generate-receipt.outputs.receipt_hash }}"
            git push
          fi
