name: Security - Secret Scanner

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  secret-scan:
    name: Scan for Secrets
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for thorough scan
      
      - name: Run Gitleaks (Secret Detection)
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
        continue-on-error: true  # Don't fail build, but report
      
      - name: Custom Secret Pattern Check
        run: |
          echo "ğŸ” Scanning for common secret patterns..."
          
          FOUND_SECRETS=0
          
          # Check for private key headers
          echo "Checking for PEM private key headers..."
          if grep -rn "-----BEGIN.*PRIVATE KEY-----" --include="*.pem" --include="*.key" --include="*.txt" . 2>/dev/null; then
            echo "âŒ CRITICAL: Private key headers found!"
            FOUND_SECRETS=1
          fi
          
          # Check for RSA private keys
          if grep -rn "-----BEGIN RSA PRIVATE KEY-----" . 2>/dev/null | grep -v ".git"; then
            echo "âŒ CRITICAL: RSA private key found!"
            FOUND_SECRETS=1
          fi
          
          # Check for EC private keys
          if grep -rn "-----BEGIN EC PRIVATE KEY-----" . 2>/dev/null | grep -v ".git"; then
            echo "âŒ CRITICAL: EC private key found!"
            FOUND_SECRETS=1
          fi
          
          # Check for OpenSSH private keys
          if grep -rn "-----BEGIN OPENSSH PRIVATE KEY-----" . 2>/dev/null | grep -v ".git"; then
            echo "âŒ CRITICAL: OpenSSH private key found!"
            FOUND_SECRETS=1
          fi
          
          # Check for AWS credentials patterns
          if grep -rn "AKIA[0-9A-Z]\{16\}" . 2>/dev/null | grep -v ".git" | grep -v ".gitignore"; then
            echo "âŒ WARNING: Possible AWS Access Key ID found!"
            FOUND_SECRETS=1
          fi
          
          # Check for common API key patterns
          if grep -rn "api[_-]?key.*=.*['\"][a-zA-Z0-9]\{20,\}['\"]" . 2>/dev/null | grep -v ".git" | grep -v "test" | grep -v "example"; then
            echo "âš ï¸ WARNING: Possible API key assignment found!"
          fi
          
          # Check for .env files that shouldn't be committed
          if find . -name ".env" -not -name ".env.example" -not -path "./.git/*" | grep -q .; then
            echo "âŒ WARNING: .env file found in repository!"
            FOUND_SECRETS=1
          fi
          
          # Check keys/ directory for non-public keys
          if [ -d "keys" ]; then
            echo "Auditing keys/ directory..."
            for keyfile in keys/*; do
              if [ -f "$keyfile" ] && [ "$(basename "$keyfile")" != "README.md" ]; then
                # Check if file contains private key indicators
                if file "$keyfile" | grep -qi "private\|secret"; then
                  echo "âŒ CRITICAL: Potential private key in keys/: $keyfile"
                  FOUND_SECRETS=1
                fi
                # Check file name for secret indicators
                if echo "$keyfile" | grep -qi "secret\|private"; then
                  echo "âŒ CRITICAL: File named with 'secret' or 'private' in keys/: $keyfile"
                  FOUND_SECRETS=1
                fi
              fi
            done
          fi
          
          if [ $FOUND_SECRETS -eq 1 ]; then
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ğŸš¨ SECRET SCAN FAILED - POTENTIAL SECRETS DETECTED"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "Action required:"
            echo "1. Remove the identified secrets from the repository"
            echo "2. Rotate any exposed credentials immediately"
            echo "3. Use git filter-branch or BFG to purge from history"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            exit 1
          else
            echo "âœ… No obvious secrets detected"
          fi
      
      - name: Check for committed artifacts that should be gitignored
        run: |
          echo "ğŸ” Checking for artifacts that should be gitignored..."
          
          FOUND_ARTIFACTS=0
          
          # Check for __pycache__
          if find . -type d -name "__pycache__" -not -path "./.git/*" | grep -q .; then
            echo "âš ï¸ WARNING: __pycache__ directories found (should be gitignored)"
            find . -type d -name "__pycache__" -not -path "./.git/*"
            FOUND_ARTIFACTS=1
          fi
          
          # Check for .coverage
          if [ -f ".coverage" ]; then
            echo "âš ï¸ WARNING: .coverage file found (should be gitignored)"
            FOUND_ARTIFACTS=1
          fi
          
          # Check for .pyc files
          if find . -name "*.pyc" -not -path "./.git/*" | grep -q .; then
            echo "âš ï¸ WARNING: .pyc files found (should be gitignored)"
            FOUND_ARTIFACTS=1
          fi
          
          # Check for node_modules
          if [ -d "node_modules" ]; then
            echo "âš ï¸ WARNING: node_modules directory found (should be gitignored)"
            FOUND_ARTIFACTS=1
          fi
          
          # Check for .env files
          if find . -name ".env" -not -name ".env.example" -not -path "./.git/*" 2>/dev/null | grep -q .; then
            echo "âš ï¸ WARNING: .env files found (should be gitignored)"
            FOUND_ARTIFACTS=1
          fi
          
          if [ $FOUND_ARTIFACTS -eq 1 ]; then
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âš ï¸ ARTIFACT CHECK - CLEANUP RECOMMENDED"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "Run: git rm -r --cached <artifact> && git commit"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            # Don't fail on artifacts, just warn
          else
            echo "âœ… No gitignored artifacts found in repository"
          fi

  keys-audit:
    name: Audit Keys Directory
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate keys/ directory policy
        run: |
          echo "ğŸ” Auditing keys/ directory..."
          
          if [ ! -d "keys" ]; then
            echo "âœ… No keys/ directory present"
            exit 0
          fi
          
          # Ensure README exists
          if [ ! -f "keys/README.md" ]; then
            echo "âŒ POLICY VIOLATION: keys/README.md must exist with security notice"
            exit 1
          fi
          
          # Check for files named with 'secret' or 'private'
          VIOLATIONS=0
          for f in keys/*; do
            if [ -f "$f" ]; then
              basename=$(basename "$f")
              if echo "$basename" | grep -Eqi "(secret|private)"; then
                echo "âŒ POLICY VIOLATION: File '$basename' has forbidden naming"
                VIOLATIONS=1
              fi
            fi
          done
          
          if [ $VIOLATIONS -eq 1 ]; then
            echo ""
            echo "Keys directory policy requires:"
            echo "- No files named with 'secret' or 'private'"
            echo "- All keys must be PUBLIC keys only"
            echo "- README.md must document the policy"
            exit 1
          fi
          
          echo "âœ… Keys directory passes policy check"
