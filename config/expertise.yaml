# ═══════════════════════════════════════════════════════════════════════════════
# BIZRA EXPERTISE FILE (L5 Mental Model)
# ═══════════════════════════════════════════════════════════════════════════════
# This file is the agent's "Mental Model" - agent-readable AND agent-writable.
# It contains high-fidelity abstractions of the system the agent operates within.
#
# PROTOCOL: Plan-Build-Self-Improve
# 1. Plan: Planner Agent reads this file to understand constraints
# 2. Build: Builder Agent executes tasks, modifying codebase
# 3. Self-Improve: Self-Improvement Agent diffs pre/post and updates this file
#
# VERSION: This file is versioned. Changes require SAT receipt.
# ═══════════════════════════════════════════════════════════════════════════════

version: "1.0.0"
last_updated: "2025-12-27T00:00:00Z"
updated_by: "SAT-GENESIS"
schema_version: "2024.12"

# ┌─────────────────────────────────────────────────────────────────────────────┐
# │ ARCHITECTURAL INVARIANTS (Never violate these)                              │
# └─────────────────────────────────────────────────────────────────────────────┘
invariants:
  ihsan_threshold: 0.95
  snr_minimum: 0.75
  receipt_first: true
  fail_closed: true
  secrets_never_persist: true

  # Non-negotiable principles
  principles:
    - name: "Deny by default"
      description: "No tool call unless explicitly allowed by policy"
      enforcement: "SAT gate"
    - name: "Receipt-first mutation"
      description: "No state mutation without SAT Receipt"
      enforcement: "PCI envelope verification"
    - name: "Evidence-first claims"
      description: "No claims without Evidence Pack"
      enforcement: "CLAIM_REGISTRY.yaml validation"

# ┌─────────────────────────────────────────────────────────────────────────────┐
# │ DATA LINEAGE MAPS                                                           │
# └─────────────────────────────────────────────────────────────────────────────┘
data_lineage:
  # How data flows between memory layers
  memory_flow:
    L1_to_L2:
      trigger: "tool_success OR steps >= 3"
      operation: "granular_condensation"
      compression_target: 0.618  # Golden ratio
    
    L2_to_L3:
      trigger: "subtask_complete OR retry_count >= 2"
      operation: "deep_consolidation"
      fibonacci_schedule: [13, 21, 34, 55, 89, 144]
    
    L3_to_L4:
      trigger: "episode_verified AND novelty_score > 0.7"
      operation: "hyperedge_creation"
      requires_neo4j: true
    
    L4_to_L5:
      trigger: "pattern_repeated >= 3 AND success_rate > 0.95"
      operation: "crystallization"
      requires_sat_receipt: true

  # Primary data stores
  stores:
    neo4j:
      uri: "bolt://localhost:7687"
      database: "bizra_knowledge"
      purpose: "L4 HyperGraph semantic memory"
    
    event_log:
      path: "data/event_log.jsonl"
      format: "append-only JSONL with hash chain"
      purpose: "L3 episodic memory persistence"
    
    expertise_store:
      path: "data/expertise/"
      format: "content-addressable SHA-256"
      purpose: "L5 crystallized tools"

# ┌─────────────────────────────────────────────────────────────────────────────┐
# │ VERIFIED SCHEMAS                                                            │
# └─────────────────────────────────────────────────────────────────────────────┘
schemas:
  pci_envelope:
    version: "1.0"
    required_fields:
      - proposal_hash
      - state_before
      - state_after
      - ihsan_score
      - signature
    
  commit_receipt:
    version: "1.0"
    required_fields:
      - receipt_id
      - envelope_digest
      - verifier_set
      - audit_digest
      - timestamp

  evidence_pack:
    structure:
      - manifest.json
      - run.json
      - tool_calls.jsonl
      - logs.txt
      - diffs/
      - artifacts/
      - metrics.json
      - sha256sums.txt
      - receipts.jsonl
      - replay.md

# ┌─────────────────────────────────────────────────────────────────────────────┐
# │ DOMAIN EXPERTISE (Learned from interactions)                                │
# └─────────────────────────────────────────────────────────────────────────────┘
domain_knowledge:
  bizra_concepts:
    - name: "Third Fact"
      description: "The synthesis of opposing viewpoints into higher truth"
      related: ["Ihsān", "Graph of Thoughts"]
    
    - name: "Dual-Agentic System"
      description: "PAT executes, SAT verifies. No self-approval."
      components: ["PAT", "SAT", "Router"]
    
    - name: "HyperGraph RAG"
      description: "N-ary relationships via hyperedges, not binary triples"
      implementation: "L4SemanticHyperGraph + Neo4j"
    
    - name: "FATE Engine"
      description: "Formal Alignment & Transcendence Engine"
      purpose: "Verify proposals against policy and Ihsān constraints"

  architectural_patterns:
    - pattern: "Parent-child cascade delete"
      applies_to: ["Episodes", "Hyperedges"]
      constraint: "Deleting parent removes all children"
    
    - pattern: "Append-only with Merkle chain"
      applies_to: ["event_log", "L3EpisodicMemory"]
      constraint: "Never modify, only append. Verify chain integrity."
    
    - pattern: "Content-addressable storage"
      applies_to: ["expertise_store", "L5 tools"]
      constraint: "Hash-based addressing, immutable once stored"

# ┌─────────────────────────────────────────────────────────────────────────────┐
# │ CRYSTALLIZED TOOLS (L5 Procedural Memory Index)                             │
# └─────────────────────────────────────────────────────────────────────────────┘
crystallized_tools:
  # Tools are stored in expertise_store with content-addressable hashes
  # This index maps tool names to their fingerprints for quick lookup
  
  index: {}  # Populated by AATC Reflector
  
  # Schema for each tool entry:
  # tool_name:
  #   hash: "sha256..."
  #   fingerprint: "contextual UI state hash for matching"
  #   success_rate: 0.0-1.0
  #   invocation_count: N
  #   last_used: "ISO timestamp"
  #   created_by: "session_id"
  #   receipt_id: "SAT receipt binding"

# ┌─────────────────────────────────────────────────────────────────────────────┐
# │ FOLDING STRATEGY CONFIG (AgentFold)                                         │
# └─────────────────────────────────────────────────────────────────────────────┘
folding_strategy:
  # Granular Condensation (L1 → L2)
  granular:
    triggers:
      - condition: "tool_success AND steps_since_last_fold >= 3"
        action: "compress_latest_interaction"
      - condition: "token_count > 3000"
        action: "force_compression"
    
    compression_target: 0.618  # Golden ratio
    min_entropy: 3.5  # Shannon entropy threshold
  
  # Deep Consolidation (L2 → L3)
  deep:
    triggers:
      - condition: "subtask_complete"
        action: "fuse_l2_sequence"
      - condition: "tool_failure AND retry_count >= 2"
        action: "prune_failed_branch"
      - condition: "fibonacci_step_reached"
        action: "scheduled_consolidation"
    
    fibonacci_schedule:
      enabled: true
      sequence: [13, 21, 34, 55, 89, 144, 233, 377]
      purpose: "Non-linear checkpoints for long-horizon tasks"

  # Safety constraints
  safety:
    max_compression_ratio: 0.90  # Never compress more than 90%
    preserve_safety_warnings: true
    preserve_error_lessons: true
    require_entropy_check: true

# ┌─────────────────────────────────────────────────────────────────────────────┐
# │ VALIDATION RULES                                                            │
# └─────────────────────────────────────────────────────────────────────────────┘
validation:
  # Every update to this file must pass these checks
  before_commit:
    - check: "schema_valid"
      description: "YAML must parse and match schema"
    - check: "invariants_preserved"
      description: "Cannot modify invariants section without human approval"
    - check: "sat_receipt_required"
      description: "Changes require SAT signature"
  
  # Entropy check for any new knowledge
  knowledge_quality:
    min_entropy: 3.5
    max_similarity_to_existing: 0.85
    require_source_reference: true
